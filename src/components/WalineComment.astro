---
// Waline评论组件
---

<div id="waline-comment"></div>

<script>
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

  // 自定义时间格式化函数
  function formatTime(date) {
    const now = new Date();
    const diff = now - new Date(date);
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const weeks = Math.floor(days / 7);
    const months = Math.floor(days / 30);
    const years = Math.floor(days / 365);

    if (seconds < 60) return '刚刚';
    if (minutes < 60) return `${minutes} 分钟前`;
    if (hours < 24) return `${hours} 小时前`;
    if (days < 7) return `${days} 天前`;
    if (weeks < 4) return `${weeks} 周前`;
    if (months < 12) return `${months} 个月前`;
    return `${years} 年前`;
  }

  // 等待页面加载完成
  document.addEventListener('DOMContentLoaded', function() {
    // 检查是否已经初始化过
    if (document.querySelector('#waline-comment .wl-container')) {
      return;
    }

    init({
      el: '#waline-comment',
      serverURL: 'https://waline-comment-lovat-phi.vercel.app',
      placeholder: '说点什么吧...',
      avatar: 'monsterid',
      meta: ['nick', 'mail', 'link'],
      requiredMeta: ['nick'],
      login: 'disable', // 禁用登录，支持匿名评论
      wordLimit: 0, // 取消字数限制
      pageSize: 10,
      lang: 'zh-CN',
      locale: {
        placeholder: '请留下你的足迹~',
        sofa: '来发评论吧~',
        submit: '提交',
        reply: '回复',
        cancelReply: '取消回复',
        comment: '评论',
        refresh: '刷新',
        more: '加载更多...',
        preview: '预览',
        emoji: '表情',
        uploadImage: '上传图片',
        // 正确的时间本地化键名
        second: '秒前',
        minute: '分钟前',
        hour: '小时前',
        day: '天前',
        week: '周前',
        month: '个月前',
        year: '年前',
        now: '刚刚',
        // 其他本地化
        admin: '博主',
        sticky: '置顶',
        word: '字',
        wordHint: '请输入评论内容',
        anonymous: '匿名',
        level0: '潜水',
        level1: '冒泡',
        level2: '吐槽',
        level3: '活跃',
        level4: '话痨',
        level5: '传说'
      },
      // 暗色主题适配
      dark: 'auto',
      // 表情包配置
      emoji: [
        '//unpkg.com/@waline/emojis@1.2.0/weibo',
        '//unpkg.com/@waline/emojis@1.2.0/alus',
        '//unpkg.com/@waline/emojis@1.2.0/bilibili'
      ],
      // 图片上传
      imageUploader: false,
      // 数学公式支持
      texRenderer: false,
      // 代码高亮
      highlighter: false,
      // 自定义时间格式化
      formatTime: formatTime
    });

    // 修复已渲染的时间显示
    setTimeout(() => {
      const timeElements = document.querySelectorAll('.wl-time');
      timeElements.forEach(el => {
        const timeText = el.textContent;
        if (timeText && timeText.includes('N')) {
          // 尝试从data属性或其他方式获取原始时间
          const timeAttr = el.getAttribute('datetime') || el.getAttribute('title');
          if (timeAttr) {
            el.textContent = formatTime(timeAttr);
          }
        }
      });
    }, 1000);
  });

  // Astro页面切换时重新初始化
  document.addEventListener('astro:page-load', function() {
    // 清理旧的评论区
    const walineContainer = document.querySelector('#waline-comment');
    if (walineContainer) {
      walineContainer.innerHTML = '';
    }
    
    // 重新初始化
    setTimeout(() => {
      if (typeof init !== 'undefined') {
        init({
          el: '#waline-comment',
          serverURL: 'https://waline-comment-lovat-phi.vercel.app',
          placeholder: '说点什么吧...',
          avatar: 'monsterid',
          meta: ['nick', 'mail', 'link'],
          requiredMeta: ['nick'],
          login: 'disable',
          wordLimit: 0, // 取消字数限制
          pageSize: 10,
          lang: 'zh-CN',
          dark: 'auto',
          locale: {
            placeholder: '请留下你的足迹~',
            sofa: '来发评论吧~',
            submit: '提交',
            reply: '回复',
            cancelReply: '取消回复',
            comment: '评论',
            refresh: '刷新',
            more: '加载更多...',
            preview: '预览',
            emoji: '表情',
            uploadImage: '上传图片',
            // 正确的时间本地化键名
            second: '秒前',
            minute: '分钟前',
            hour: '小时前',
            day: '天前',
            week: '周前',
            month: '个月前',
            year: '年前',
            now: '刚刚'
          }
        });
      }
    }, 100);
  });
</script>

<style>
  #waline-comment {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  /* 适配你的博客风格 */
  :global(.wl-container) {
    font-family: inherit !important;
  }

  :global(.wl-editor) {
    background-color: var(--bg-color) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 6px !important;
    color: var(--text-color) !important;
  }

  :global(.wl-btn) {
    background-color: var(--text-color) !important;
    color: var(--bg-color) !important;
    border: none !important;
    border-radius: 4px !important;
    padding: 8px 16px !important;
    font-size: 14px !important;
    transition: opacity 0.2s ease !important;
  }

  :global(.wl-btn:hover) {
    opacity: 0.8 !important;
  }

  :global(.wl-card) {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    box-shadow: 0 1px 3px var(--shadow-color) !important;
  }

  :global(.wl-nick) {
    color: var(--heading-color) !important;
    font-weight: 600 !important;
  }

  :global(.wl-time) {
    color: var(--text-color) !important;
    opacity: 0.7 !important;
    font-size: 12px !important;
  }

  :global(.wl-content) {
    color: var(--text-color) !important;
    line-height: 1.6 !important;
  }

  :global(.wl-meta) {
    border-top: 1px solid var(--border-color) !important;
  }

  :global(.wl-count) {
    color: var(--text-color) !important;
    font-size: 14px !important;
  }

  /* 深色主题适配 */
  [data-theme="dark"] :global(.wl-editor) {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
    color: var(--text-color) !important;
  }

  [data-theme="dark"] :global(.wl-card) {
    background-color: var(--card-bg) !important;
    border-color: var(--border-color) !important;
  }

  [data-theme="dark"] :global(.wl-btn) {
    background-color: var(--text-color) !important;
    color: var(--bg-color) !important;
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    #waline-comment {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
    }

    :global(.wl-editor) {
      font-size: 14px !important;
    }

    :global(.wl-btn) {
      padding: 6px 12px !important;
      font-size: 13px !important;
    }
  }
</style>